#!/bin/bash 

# Functions -----------------------------------------------------------
function help {
  echo $1 # Error message passed to this method
  echo "Usage: ./pingscript.sh [Class C network] [begin_ip] [end_ip]"
  echo "example: ./pingscript.sh 192.168.20 100 105"
  exit 1 # Exit out of whole script, not just function
}

function check_range {
  # $1 is number to check within 0-255
  if ! [ $1 -lt 255 ] && [ $1 -gt 0 ]; then
    help "$1 is not in IP range"
  fi
}

function check_regex { # $1 is var, $2 is regex
  if ! [[ $1 =~ $2 ]]; then
    # It doesn't pass
    help "$1 does not pass data type validation"
  fi
}

# Arg Parse -----------------------------------------------------------
# Check arg count
if [ "$#" -ne 3 ]; then
  help "There were not 3 args passed... Exiting"
fi

# Input Validation
classC='([0-9]+[0-9]?[.]+)+'
octet='(^[0-9]+[0-9]?$)'
check_regex $1 $classC
check_regex $2 $octet
check_regex $3 $octet

# Check numbers in range
classCarray=$(echo $1 | tr '.' ' ')
for ip in "${classCarray[@]}"; do
  check_range $ip
done
check_range $2
check_range $3

# Make sure begin_ip ($2) is less than end_ip ($3)
if [ $2 -gt $3 ] || [ $2 -eq $3 ]; then
  help "$2 is not less than $3"
fi

# Start tcpdump and ping ----------------------------------------------
if [ -f hw2.pcap ]; then # If file exists
  rm -f hw2.pcap
fi

tcpdump -XX -i any -v icmp -w hw2.pcap &

for x in `seq $2 $3`; do 
  ping -c 1 $1.$x | grep "64 bytes" | cut -d" " -f4 | sed 's/.$//' 
done

# Kill tcpdump
# process list, get tcpdump, get rid of second line which is this command itself, then get PID
kill $(ps aux | grep tcpdump | head -n 1 | awk -F ' ' '{print $2}')

# Display captured packets, because simply running `cat hw2.pcap` doesn't work
tcpdump -tttt -r hw2.pcap